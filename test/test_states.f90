program teststates

use assertions
use bodies
use constants
use epochs
use types, only: dp

implicit none

type(epoch) :: ep
real(dp), dimension(6,6) :: ref
real(dp), dimension(3,3) :: m
real(dp), dimension(3,3) :: dm

ep = new_epoch(2000, 1, 1, 12) + new_epochdelta(seconds=1000._dp)
call load_constants

! Reference data from WebGeocalc (http://wgc.jpl.nasa.gov/)
ref = transpose(reshape([ &
    0.93161546_dp, &
    -0.27117375_dp, &
    -0.24198643_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.35177121_dp, &
    0.84016564_dp, &
    0.41276956_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.09137641_dp, &
    -0.46966636_dp, &
    0.87810242_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    4.36141153E-07_dp, &
    1.04167363E-06_dp, &
    5.11769580E-07_dp, &
    0.93161546_dp, &
    -0.27117375_dp, &
    -0.24198643_dp, &
    -1.15505708E-06_dp, &
    3.36212903E-07_dp, &
    3.00025285E-07_dp, &
    0.35177121_dp, &
    0.84016564_dp, &
    0.41276956_dp, &
    -8.06548746E-14_dp, &
    -3.99346680E-14_dp, &
    -1.29666162E-14_dp, &
    0.09137641_dp, &
    -0.46966636_dp, &
    0.87810242_dp &
], [6, 6]))
call iaumatrix(mercury, ep, m, dm)
call assert_almost_equal(m, ref(1:3, 1:3), __LINE__)
call assert_almost_equal(dm, ref(4:6, 1:3), __LINE__)

ref = transpose(reshape([ &
    -0.95473270_dp, &
    0.26677448_dp, &
    0.13159348_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    -0.29687729_dp, &
    -0.88233398_dp, &
    -0.36517205_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.01869081_dp, &
    -0.38770881_dp, &
    0.92159239_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    8.88390262E-08_dp, &
    2.64033981E-07_dp, &
    1.09275888E-07_dp, &
    -0.95473270_dp, &
    0.26677448_dp, &
    0.13159348_dp, &
    -2.85698932E-07_dp, &
    7.98309152E-08_dp, &
    3.93786831E-08_dp, &
    -0.29687729_dp, &
    -0.88233398_dp, &
    -0.36517205_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.01869081_dp, &
    -0.38770881_dp, &
    0.92159239_dp &
], [6, 6]))
call iaumatrix(venus, ep, m, dm)
call assert_almost_equal(m, ref(1:3, 1:3), __LINE__)
call assert_almost_equal(dm, ref(4:6, 1:3), __LINE__)

ref = transpose(reshape([ &
    0.24742306_dp, &
    -0.96890755_dp, &
    -7.62199719E-10_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.96890755_dp, &
    0.24742306_dp, &
    -2.98477054E-09_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    3.08055248E-09_dp, &
    -1.09209406E-17_dp, &
    1.00000000_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    7.06538526E-05_dp, &
    1.80423738E-05_dp, &
    -9.79852602E-13_dp, &
    0.24742306_dp, &
    -0.96890755_dp, &
    -7.62199719E-10_dp, &
    -1.80423738E-05_dp, &
    7.06538526E-05_dp, &
    -2.92918995E-12_dp, &
    0.96890755_dp, &
    0.24742306_dp, &
    -2.98477054E-09_dp, &
    3.08055237E-12_dp, &
    -2.18418808E-20_dp, &
    -9.48980323E-21_dp, &
    3.08055248E-09_dp, &
    -1.09209406E-17_dp, &
    1.00000000_dp &
], [6, 6]))
call iaumatrix(earth, ep, m, dm)
call assert_almost_equal(m, ref(1:3, 1:3), __LINE__)
call assert_almost_equal(dm, ref(4:6, 1:3), __LINE__)

ref = transpose(reshape([ &
    -0.66608963_dp, &
    -0.74583619_dp, &
    -0.00727954_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.59771816_dp, &
    -0.52791987_dp, &
    -0.60335198_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.44615873_dp, &
    -0.40623761_dp, &
    0.79744178_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    4.23675661E-05_dp, &
    -3.74201109E-05_dp, &
    -4.27669044E-05_dp, &
    -0.66608963_dp, &
    -0.74583619_dp, &
    -0.00727954_dp, &
    4.72138849E-05_dp, &
    5.28664951E-05_dp, &
    5.15989714E-07_dp, &
    0.59771816_dp, &
    -0.52791987_dp, &
    -0.60335198_dp, &
    -3.97806628E-14_dp, &
    -4.42633886E-13_dp, &
    -2.03232447E-13_dp, &
    0.44615873_dp, &
    -0.40623761_dp, &
    0.79744178_dp &
], [6, 6]))
call iaumatrix(mars, ep, m, dm)
call assert_almost_equal(m, ref(1:3, 1:3), __LINE__)
call assert_almost_equal(dm, ref(4:6, 1:3), __LINE__)

ref = transpose(reshape([ &
    0.39505525_dp, &
    -0.83169183_dp, &
    -0.39015388_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.91854138_dp, &
    0.35086343_dp, &
    0.18214441_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    -0.01459729_dp, &
    -0.43032959_dp, &
    0.90255380_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00000000E+00_dp, &
    0.00016153_dp, &
    6.17004691E-05_dp, &
    3.20306845E-05_dp, &
    0.39505525_dp, &
    -0.83169183_dp, &
    -0.39015388_dp, &
    -6.94717442E-05_dp, &
    0.00014626_dp, &
    6.86098223E-05_dp, &
    0.91854138_dp, &
    0.35086343_dp, &
    0.18214441_dp, &
    -5.69989759E-14_dp, &
    4.64700233E-15_dp, &
    1.29378658E-15_dp, &
    -0.01459729_dp, &
    -0.43032959_dp, &
    0.9025538_dp &
], [6, 6]))
call iaumatrix(jupiter, ep, m, dm)
call assert_almost_equal(m, ref(1:3, 1:3), __LINE__)
call assert_almost_equal(dm, ref(4:6, 1:3), __LINE__, atol=1e-8_dp)
end program teststates
